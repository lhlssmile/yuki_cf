# lcRank476 D 题要点：稳定子数组计数

- 稳定子数组等价于非递减子数组。
- 预处理 `E[i]` 为从位置 `i` 开始的最长非递减段的右端点。
- 对于查询 `[l,r]`，答案为 `sum_{i=l..r} (min(E[i], r) - i + 1)`。
- 将 `min(E[i], r)` 拆分为两类：`E[i] <= r` 与 `E[i] > r`。
- 离线按 `r` 递增处理查询：当 `r` 到某值时，把所有 `E[i]==r` 的起点 `i` 加入树状数组。
- 两个树状数组：一个维护区间内 `E[i]` 的和，一个维护计数。
- 公式：
  - `len = r - l + 1`
  - `sumE = sum(E[i] over i in [l,r] with E[i] <= r)`
  - `cnt = count(i in [l,r] with E[i] <= r)`
  - `sumMin = sumE + r * (len - cnt)`
  - `sumIdx = l + (l+1) + ... + r`
  - `ans = sumMin - sumIdx + len`

示例：`a = [7, 12, 3, 34, 22, 89]`
- `[0,5]`：总计 `9`
- `[0,2]`：`[7],[7,12],[12],[3]` 共 `4`
- `[3,5]`：`[34],[22],[22,89],[89]` 共 `4`
- `[1,3]`：`[12],[3],[3,34],[34]` 共 `4`